<div id='gamecontainer' class='align-items-middle'>
  <div id='bigtext' class='display-2 text-center align-middle  align-self-center'></div>
  <button id='startbutton' class='btn btn-primary btn-lg btn-block flex-row align-self-center mt-3' style='display:none;'>Start</button>
  <button id='nextroundbutton' class='btn btn-primary btn-lg btn-block flex-row align-self-center mt-3' style='display:none;'>Another Round?</button>
  <div id='qlist'></div>
  <div id='votelist'></div>
  <table id='scoretable'></table>

  <div id='votestemplate' class='input-group mb-3' style='display:none;'>
    <button class='btn btn-outline-secondary' type='button' onclick='gameRoom.game.clickVote(true, this);'>Yes</button>
    <button class='btn btn-outline-secondary' type='button' onclick='gameRoom.game.clickVote(false, this);'>No</button>
    <span id='votelabel'>label</span>
  </div>
</div>
<script>
QUESTION_SETS = [
  [
    "Type of candy",
    "Car manufacturer",
    "Musical instrument",
    "Living politician",
    "Vegetable",
    "Article of clothing",
    "Dead politician",
    "Grocery store chain",
    "Video game",
    "Sport",
    "Gardening tool",
    "Disney character",
  ],
  [
    "Home appliance",
    "Zoo animal",
    "Legume",
    "Animated movie",
    "Color",
    "Actress",
    "State",
    "Live-action movie",
    "Bug",
    "Cooked dish",
    "Power tool",
    "TV show",
  ],
  [
    "Career",
    "Country",
    "Dog breed",
    "Song name",
    "Programming language",
    "Cookware",
    "Berry",
    "Book title",
    "Super Smash Bros. character",
    "Actor",
    "President",
    "Movie adaptation",
  ]
]

function Game(gameRoom) {
  console.log(gameRoom);

  gameBase.call(this,gameRoom);

  this.players = {};

  const WAITING = 0;
  const LIST = 1;
  const VOTE = 2;
  const SCORE = 3;
  this.gameState = WAITING;
  this.setGameState = function (newState) {
    $('#bigtext').text('');
    $('#votestemplate').hide();
    $('#startbutton').hide();
    $('#nextRoundButton').hide();
    if (newState == WAITING) {
      $('#qlist').hide();
      $('#votelist').hide();
      $('#scoretable').hide();
    } else if (newState == LIST) {
      $('#qlist').show();
      $('#votelist').hide();
      $('#scoretable').hide();
    } else if (newState == VOTE) {
      $('#qlist').hide();
      $('#votelist').show();
      $('#scoretable').hide();
    } else if (newState == SCORE) {
      $('#qlist').hide();
      $('#votelist').hide();
      $('#scoretable').show();
    }
    this.gameState = newState;
  }

  this.setup = function() {
    this.setGameState(WAITING);
    this.questionSetIdx = 0;
    this.votingAnswerIdx = 0;

    $('#footer').empty();
    $('#header').empty();
    $('#header').text(this.gameRoom.name);

    if(this.isHost === false) {
      $('#bigtext').text('Waiting on host...');
    } else {
      this.setSyncVar('player answers', {});
      this.setSyncVar('player votes', {});
      this.setSyncVar('player scores', {});
      $('#bigtext').text('Waiting for players');
      thisGame = this

      $('#startbutton').show();
      $('#startbutton').click(function() {
        thisGame.gameRoom.setRoomClosed();
        var letter = String.fromCharCode(Math.floor(Math.random() * 26) + 65);
        thisGame.setSyncVar('currentLetter', letter);
        thisGame.gameRoom.sendToEveryone('start round countdown', '');

        // setup answers and scores
        var answers = thisGame.getSyncVar('player answers');
        var votes = thisGame.getSyncVar('player votes');
        var scores = thisGame.getSyncVar('player scores');
        for (var i = 0; i < thisGame.playerList.length; i++) {
          var player = thisGame.playerList[i];
          answers[player.ID] = {}; // this is formatted like 'a0': 'Firetruck'
          votes[player.ID] = []; // this is just a big pile of vote objs
          scores[player.ID] = []; // this is a list of scores for each round
        }
        thisGame.setSyncVar('player answers', answers);
        thisGame.setSyncVar('player votes', votes);
        thisGame.setSyncVar('player scores', scores);
        $('#startbutton').click(function() {});
        $('#startbutton').hide();
      });

      this.refreshPlayers();
    }

    this.started = true;
  }

  this.setHandler('set color', function(from, color){
    // colorNum = parseInt(color);
    console.log("color " + color);
    $('#header').removeClass("bg-secondary playerbg-1  playerbg-2  playerbg-3 playerbg-4 playerbg-5 playerbg-6 playerbg-7 playerbg-8 playerbg-9 playerbg-10")
    $('#header').addClass("playerbg-light-" + (color + 1));
  })

  this.refreshPlayers = function(_, __) {
    console.log("Updated player list...");
    console.log(this.playerList);
    for (var i = 0; i < this.playerList.length; i++) {
      var playerInfo = this.playerList[i];
      if (!this.players.hasOwnProperty(playerInfo.ID)) {
        console.log("new player");
        console.log(playerInfo);
        this.gameRoom.sendToPlayer(playerInfo.ID, 'set color', i);
      }
    }
  };
  this.setHandler('update player list', this.refreshPlayers);

  this.setHandler('start round countdown', function (_, __) {
    $('#bigtext').text("Letter: " + this.getSyncVar('currentLetter') + '\nStarting in 5');
    this.setHandler('tick timer', function(_, time) {
      $('#bigtext').text("Letter: " + this.getSyncVar('currentLetter') + '\nStarting in ' + time);
    });
    this.setHandler('finish timer', function(_, __) {
      $('#bigtext').text("Letter: " + this.getSyncVar('currentLetter') + '\nStarting...');
      if (this.isHost) {
        this.setSyncVar('currentList', Math.floor(Math.random() * QUESTION_SETS.length));
        this.gameRoom.sendToEveryone('start round', this.getSyncVar('currentList'));
      }
    });
    if (this.isHost) {
      thisGame.gameRoom.startTimer(5);
    }
  });

  this.setHandler('start round', function (from, index) {
    this.questionSetIdx = index;
    this.setGameState(LIST);
    var list = $('#qlist');
    list.empty();
    for (var i = 0; i < 12; i++) {

      list.append($('<label>').text("" + (i + 1) + ". " + QUESTION_SETS[this.questionSetIdx][i]).prop({for:'a'+i}));

      list.append($('<div>').prop({class:"input-group mb-3"}).append(
        $('<input>').prop({ id: "a" + i, autocomplete: 'off', class: "form-control answers", prompt: i.toString(), type: "text"})));
    }

    var seconds = 60 * 2;
    seconds = 15;
    var letter = this.getSyncVar('currentLetter');
    $('#bigtext').text('Letter: ' + letter + '\nTime left: ' + seconds);
    if (this.isHost) {
      this.gameRoom.startTimer(seconds);
    }
    this.setHandler('tick timer', function(_, time) {
      $('#bigtext').text('Letter: ' + letter + '\nTime left: ' + time);
    });
    this.setHandler('finish timer', function(_, __) {
      // TODO: Start scoring I have a whole voting system in mind
      // Step 1 is tell each player to send over answers
      // Step 2 display all ansers for question 1
      // Step 3 people vote and decide if valid answer
      // Step 4 record score and repeat 1-4 for all answer sets
      // Step 5 display scores
      $('#bigtext').text('Letter: ' + letter + '\nTime\'s up');
      this.sendAnswers();

      //if (this.isHost) {
      //  this.gameRoom.sendToEveryone('send answers', '');
      //}
    });

  });

  this.sendAnswers = function () {
    this.setGameState(WAITING);
    $('#bigtext').text("Round over.\nGet ready to score");
    thisGame = this;
    var answers = {};
    $('.answers').each(function (){
      answers[$(this).attr('id')] = $(this).val();
    });
    console.log("Player answers")
    console.log(answers);
    this.gameRoom.sendToHost('player answers', answers);
  
    thisGame = this;
    setTimeout(function () {
      thisGame.votingAnswerIdx = 0;
      thisGame.displayVoting();
    },5000);
  };

  this.setHandler('player answers', function(from, answers) {
    console.log("got player answers");
    console.log(from);
    console.log(answers);
    var allAnswers = this.getSyncVar('player answers');
    allAnswers[from] = answers;
    console.log("New all answers");
    console.log(allAnswers);
    this.setSyncVar('player answers', allAnswers);
  });

  this.displayVoting = function() {
    this.setGameState(VOTE);
    // TODO: After each voting ends, call again with the next index until we're done
    // Display for players is https://getbootstrap.com/docs/4.0/components/buttons/#checkbox-and-radio-buttons
    // with the text next to it and only 2 buttons thumbs up and down (already included material ui icons)
    // for each ite,
    // submit button in footer
    // Display for host is each answer for the round with an up/down icon colored for the player that voted that way
    // setup answers and scores
    $('#bigtext').text("" + this.votingAnswerIdx + ". " + QUESTION_SETS[this.questionSetIdx][this.votingAnswerIdx]);
    $('#votelist').empty();
    var answers = this.getSyncVar('player answers');
    for (var i = 0; i < this.playerList.length; i++) {
      var playerID = this.playerList[i].ID;
      // TODO record what happens when the buttons go
      var playerAnswer = answers[playerID]['a' + this.votingAnswerIdx];
      var entry = $('<div>').prop({class:'col pt-1'});
      var voteClone = $('#votestemplate').clone();
      voteClone.attr('id', 'vote_' + playerID);
      var voteLabel = voteClone.find('#votelabel');
      voteLabel.removeAttr('id');
      voteLabel.text(playerAnswer);
      entry.append(voteClone);
      voteClone.show();
      $('#votelist').append(voteClone);
    }
    
    var thisGame = this;
    setTimeout(function () {
      thisGame.votingAnswerIdx++;
      if (thisGame.votingAnswerIdx < 12) {
        thisGame.displayVoting();
      } else { 
        thisGame.waitForScores();
      }
    }, 5000);
  };

  this.clickVote = function (yes, button) {
    $(button).attr('onclick', '');
    $(button).siblings().each(function() {
      // "this" now refers to the items being iterated
      if ($(this).is('button')) {
        $(this).attr('onclick', ''); // disable on click behavior
        $(this).hide();
      }
    });
    var playerID = $(button).parent().attr('id').substr('vote_'.length);
    var voteObj = { votingAnswerIdx: this.votingAnswerIdx, playerID: playerID, yes: yes };
    this.gameRoom.sendToHost('vote', voteObj);
  }

  this.setHandler('vote', function(from, vote) {
    console.log("Received vote")
    console.log(vote);
    
    var votes = thisGame.getSyncVar('player votes');
    votes[from].push(vote);
    thisGame.setSyncVar('player votes', votes);
  });

  this.waitForScores = function() {
    this.setGameState(SCORE);
    $('#bigtext').text("Calculating scores...");
    // just give it a few seconds to even out, then calculate the scores
    if (this.isHost) {
      var thisGame = this;
      setTimeout(function () {
        thisGame.calculateRoundScores();
        // Iterate through all votes of all players
        setTimeout(function () {
          thisGame.gameRoom.sendToEveryone('display scores', {});
        }, 1000);
      }, 3000);
    }
  };

  this.calculateRoundScores = function () {
    // TODO calculate the scores here and set a sync var
    // it'll work like this
    // iterate through each answer of each person
    // iterate through each person who voted on that answer
    // calculate how many people voted yes / how many votes. 50% or less counts as no. If it's 0/0, it's no.
    // Show how many points each person has gotten
    // Votes look like: { votingAnswerIdx: this.votingAnswerIdx, playerID: playerID, yes: yes };
    var sumsPerPlayer = {};
    for (var i = 0; i < this.playerList.length; i++) {
      var playerID = this.playerList[i].ID;
      sumsPerPlayer[playerID] = { yes: [], total: [] };
      for (var j = 0; j < 12; j++) {
        sumsPerPlayer[playerID].yes.push(0);
        sumsPerPlayer[playerID].total.push(0);
      }
    }

    var votes = this.getSyncVar('player votes');
    for (var i = 0; i < this.playerList.length; i++) {
      var playerID = this.playerList[i].ID;
      var playerVotes = votes[playerID];
      for (var j = 0; j < playerVotes.length; j++) {
        var vote = playerVotes[j];
        var targetPlayerSums = sumsPerPlayer[vote.playerID];
        targetPlayerSums.yes[vote.votingAnswerIdx] += (vote.yes ? 1 : 0);
        targetPlayerSums.total[vote.votingAnswerIdx] += 1;
      }
      // clear votes when done
      votes[playerID] = [];
    }
    this.setSyncVar('player votes', votes);

    var scores = this.getSyncVar('player scores');
    for (var i = 0; i < this.playerList.length; i++) {
      var playerID = this.playerList[i].ID;
      var roundScore = 0;
      for (var j = 0; j < 12; j++) {
        var add = 0;
        if (targetPlayerSums.total[j] > 0 && (targetPlayerSums.yes[j] / targetPlayerSums.total[j] > .5)) {
          add = 1;
        }
        roundScore += add;
      }
      scores[playerID].push(roundScore);
    }
    this.setSyncVar('player scores', scores);
  }

  this.setHandler('display scores', function() {
    this.setGameState(SCORE);
    var scores = this.getSyncVar('player scores');
    var myScores = scores[this.playerID];
    $('#bigtext').text('Round ' + myScores.length + ' Scores');
    $('#scoretable').empty();
    // title row
    var row = $('<tr>');
    row.append($('<td>').text('Name'));
    row.append($('<td>').text('Round Score'));
    row.append($('<td>').text('Total Score'));
    $('#scoretable').append(row);
    for (var i = 0; i < this.playerList.length; i++) {
      var player = this.playerList[i];
      row = $('<tr>');
      var nameTD = $('<td>').text(player.ID === this.playerID ? ('<b>' + player.Name + '</b>') : player.Name);
      row.append(nameTD);
      var roundScore = scores[player.ID][(scores[player.ID].length - 1)];
      var totalScore = 0;
      for (var j = 0; j < scores[player.ID].length; j++) {
        totalScore += scores[player.ID][j];
      }
      var roundScoreTD = $('<td>').text(roundScore);
      row.append(roundScoreTD);
      var totalScoreTD = $('<td>').text(totalScore);
      row.append(totalScoreTD);
      $('#scoretable').append(row);
    }
    // Make a start button that lets you start over?
    if (this.isHost) {
      // send message "NEXT ROUND"
      $('#nextroundbutton').show();
      // TODO check if this gets overwritten every time
      $('#nextroundbutton').click(function() {
        console.log("Anoth round");
        // reset answers and votes
        var answers = thisGame.getSyncVar('player answers');
        var votes = thisGame.getSyncVar('player votes');
        for (var i = 0; i < thisGame.playerList.length; i++) {
          var player = thisGame.playerList[i];
          answers[player.ID] = {}; // this is formatted like 'a0': 'Firetruck'
          votes[player.ID] = []; // this is just a big pile of vote objs
        }
        thisGame.setSyncVar('player answers', answers);
        thisGame.setSyncVar('player votes', votes);

        var letter = String.fromCharCode(Math.floor(Math.random() * 26) + 65);
        thisGame.setSyncVar('currentLetter', letter);
        thisGame.gameRoom.sendToEveryone('start round countdown', '');
      });
    }
  });

  this.clearTimers = function() {
    this.setHandler('tick timer', function(_, time) {
    });
    this.setHandler('finish timer', function(_, __) {
    });
  }
}
</script>
