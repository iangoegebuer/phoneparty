<div id='gamecontainer' class='align-items-middle'>
  <div id='bigtext' class='display-2 text-center align-middle  align-self-center'></div>
  <button id='startbutton' class='btn btn-primary btn-lg btn-block flex-row align-self-center mt-3' value='startt'>Start</button>
  <div id='qlist' hidden></div>
  <div id='votelist' hidden></div>

  <div id='votestemplate' class='input-group mb-3' hidden>
    <div class='input-group-prepend'>
      <button class='btn btn-outline-secondary' type='button'>Yes</button>
      <button class='btn btn-outline-secondary' type='button'>No</button>
    </div>
  </div>
</div>
<script>
QUESTION_SETS = [
  [
    "Type of candy",
    "Car manufacturer",
    "Musical instrument",
    "Living politician",
    "Vegetable",
    "Article of clothing",
    "Dead politician",
    "Grocery store chain",
    "Video game",
    "Sport",
    "Gardening tool",
    "Disney character",
  ],
  [
    "Home appliance",
    "Zoo animal",
    "Legume",
    "Animated movie",
    "Color",
    "Actress",
    "State",
    "Live-action movie",
    "Bug",
    "Cooked dish",
    "Power tool",
    "TV show",
  ],
  [
    "Career",
    "Country",
    "Dog breed",
    "Song name",
    "Programming language",
    "Cookware",
    "Berry",
    "Book title",
    "Super Smash Bros. character",
    "Actor",
    "President",
    "Movie adaptation",
  ]
]

function Game(gameRoom) {
  console.log(gameRoom);

  gameBase.call(this,gameRoom);

  this.players = {};

  const WAITING = 0;
  const LIST = 1;
  const VOTE = 2;
  const SCORE = 3;
  this.gameState = WAITING;
  this.setGameState = function (newState) {
    $('#bigtext').text('');
    if (newState == WAITING) {
      $('#qlist').hide();
      $('#votelist').hide();
    } else if (newState == LIST) {
      $('#qlist').show();
      $('#votelist').hide();
    } else if (newState == VOTE) {
      $('#qlist').hide();
      $('#votelist').show();
    } else if (newState == SCORE) {
      $('#qlist').hide();
      $('#votelist').hide();
    }
    this.gameState = newState;
  }
  this.setGameState(WAITING);
  this.questionSetIdx = 0;
  this.votingAnswerIdx = 0;

  this.setup = function() {
    $('#footer').empty();
    $('#header').empty();
    $('#header').text(this.gameRoom.name);

    if(this.isHost === false) {
      this.setSyncVar('player answers', {});
      this.setSyncVar('player scores', {});
      console.log("Sending to host")
      //this.gameRoom.sendToHost("player join", {id:this.gameRoom.playerID,name:this.gameRoom.name});
      $('#bigtext').text('Waiting on host...');
    } else {
      $('#bigtext').text('Waiting for players');
      $('#startbuton').show();
      thisGame = this

      $('#startbutton').click(function() {
        thisGame.gameRoom.setRoomClosed();
        letter = String.fromCharCode(Math.floor(Math.random() * 26) + 65);
        thisGame.setSyncVar('currentLetter', letter);
        thisGame.gameRoom.sendToEveryone('start round countdown', '');

        // setup answers and scores
        var answers = thisRoom.getSyncVar('player answers');
        var scores = thisRoom.getSyncVar('player scores');
        for (var i = 0; i < thisGame.playerList.length; i++) {
          var player = thisGame.playerList[i];
          answers[player.ID] = {};
          scores[player.ID] = 0;
        }
        thisRoom.setSyncVar('player answers', answers);
        thisRoom.setSyncVar('player scores', scores);
      });

      this.refreshPlayers();
    }

    this.started = true;
  }

  this.setHandler('set color', function(from, color){
    // colorNum = parseInt(color);
    console.log("color " + color);
    $('#header').removeClass("bg-secondary playerbg-1  playerbg-2  playerbg-3 playerbg-4 playerbg-5 playerbg-6 playerbg-7 playerbg-8 playerbg-9 playerbg-10")
    $('#header').addClass("playerbg-light-" + (color + 1));
  })

  this.refreshPlayers = function(_, __) {
    console.log("Updated player list...");
    console.log(this.playerList);
    for (var i = 0; i < this.playerList.length; i++) {
      var playerInfo = this.playerList[i];
      if (!this.players.hasOwnProperty(playerInfo.ID)) {
        console.log("new player");
        console.log(playerInfo);
        this.gameRoom.sendToPlayer(playerInfo.ID, 'set color', i);
      }
    }
  };
  this.setHandler('update player list', this.refreshPlayers);

  this.setHandler('start round countdown', function (_, __) {
    $('#bigtext').text("Letter: " + this.getSyncVar('currentLetter') + '\nStarting in 5');
    this.setHandler('tick timer', function(_, time) {
      $('#bigtext').text("Letter: " + this.getSyncVar('currentLetter') + '\nStarting in ' + time);
    });
    this.setHandler('finish timer', function(_, __) {
      $('#bigtext').text("Letter: " + this.getSyncVar('currentLetter') + '\nStarting...');
      if (this.isHost) {
        this.setSyncVar('currentList', Math.floor(Math.random() * QUESTION_SETS.length));
        this.gameRoom.sendToEveryone('start round', this.getSyncVar('currentList'));
      }
    });
    if (this.isHost) {
      thisGame.gameRoom.startTimer(5);
    }
  });

  this.setHandler('start round', function (from, index) {
    this.questionSetIdx = index;
    this.setGameState(LIST);
    var list = $('#qlist');
    list.empty();
    for (var i = 0; i < 12; i++) {

      list.append($('<label>').text("" + (i + 1) + ". " + QUESTION_SETS[this.questionSetIdx][i]).prop({for:'a'+i}));

      list.append($('<div>').prop({class:"input-group mb-3"}).append(
        $('<input>').prop({ id: "a" + i, autocomplete: 'off', class: "form-control answers", prompt: i.toString(), type: "text"})));
    }

    var seconds = 60 * 2;
    seconds = 15;
    $('#bigtext').text('Letter: ' + letter + '\nTime left: ' + seconds);
    if (this.isHost) {
      this.gameRoom.startTimer(seconds);
    }
    this.setHandler('tick timer', function(_, time) {
      $('#bigtext').text('Letter: ' + letter + '\nTime left: ' + time);
    });
    this.setHandler('finish timer', function(_, __) {
      // TODO: Start scoring I have a whole voting system in mind
      // Step 1 is tell each player to send over answers
      // Step 2 display all ansers for question 1
      // Step 3 people vote and decide if valid answer
      // Step 4 record score and repeat 1-4 for all answer sets
      // Step 5 display scores
      $('#bigtext').text('Letter: ' + letter + '\nTime\'s up');
      this.sendAnswers();

      //if (this.isHost) {
      //  this.gameRoom.sendToEveryone('send answers', '');
      //}
    });

  });

  this.sendAnswers = function () {
    this.setGameState(WAITING);
    $('#bigtext').text("Round over.\nGet ready to score");
    thisGame = this;
    var answers = {};
    $('.answers').each(function (){
      answers[$(this).attr('id')] = $(this).val();
    });
    console.log("Player answers")
    console.log(answers);
    this.gameRoom.sendToHost('player answers', answers);
  
    thisGame = this;
    setTimeout(function () {
      thisGame.votingAnswerIdx = 0;
      thisGame.displayVoting();
    },5000);
  };

  this.setHandler('player answers', function(from, answers) {
    console.log("got player answers");
    console.log(from);
    console.log(answers);
    var allAnswers = this.getSyncVar('player answers');
    allAnswers[from] = answers;
    console.log("New all answers");
    console.log(allAnswers);
    this.setSyncVar('player answers', allAnswers);
  });

  this.displayVoting = function() {
    this.setGameState(VOTE);
    // @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
    // TODO: After each voting ends, call again with the next index until we're done
    // Display for players is https://getbootstrap.com/docs/4.0/components/buttons/#checkbox-and-radio-buttons
    // with the text next to it and only 2 buttons thumbs up and down (already included material ui icons)
    // for each ite,
    // submit button in footer
    // Display for host is each answer for the round with an up/down icon colored for the player that voted that way
    // setup answers and scores
    $('#bigtext').text(QUESTION_SETS[this.questionSetIdx][this.votingAnswerIdx]);
    $('#votelist').empty();
    var answers = this.getSyncVar('player answers');
    for (var i = 0; i < this.playerList.length; i++) {
      var playerID = this.playerList[i].ID;
      // TODO record what happens when the buttons go
      var playerAnswer = answers[playerID]['a' + this.votingAnswerIdx];
      var entry = $('<div>').prop({class:'col pt-1'});
      entry.append($('#votestemplate').clone());
      $('#voteslist').append(entry);
    }
    
    var thisGame = this;
    setTimeout(function () {
      thisGame.votingAnswerIdx++;
      if (thisGame.votingAnswerIdx < 12) {
        thisGame.displayVoting();
      } else { 
        thisGame.displayScores();
      }
    }, 5000);
  };

  this.displayScores = function() {
    $('#bigtext').text("SCORES BLAH BLAH");
    // Make a start button that lets you start over?
    if (this.isHost) {

    }
  };

  this.clearTimers = function() {
    this.setHandler('tick timer', function(_, time) {
    });
    this.setHandler('finish timer', function(_, __) {
    });
  }
}
</script>
